<?php
class categories extends Admin_Controller
{
	function __construct()
	{
		parent::__construct();
		$this->template->set_layout('lightbox');
	}
	
	function index($module = FALSE)
	{
		$categories = new Category();
		$data['categories'] = $categories->get_page("SELECT CONCAT(REPEAT( '&#149;&#151; ', (COUNT(parent.name) - 1) ), node.name) AS name
					,node.description,node.slug,node.id 
					FROM categories AS node,
					categories AS parent
					WHERE node.lft BETWEEN parent.lft AND parent.rgt
					AND parent.module = '".$module."'
					AND node.module = '".$module."' 
					AND parent.parents <> 0
					AND node.parents <> 0
					GROUP BY node.name
					ORDER BY node.lft
					");
					die($categories->check_last_query());
		$this->template->build('admin/category_index',$data);
	}
	
	function form($module,$id=FALSE)
	{
			$data['module'] = $module;
			$data['rs'] = $this->category->get_row($id);
			$this->template->build('admin/category_form',$data);
	}
	
	function save()
	{
		if(@$_POST['slug']=="")
		{
			$_POST['slug'] = clean_url($_POST['name']);
		}
		$this->category->save($_POST);
		set_notify('success', lang('save_data_complete'));
		redirect('category/admin/category/'.$module);
	}
	
	function delete($id)
	{
		$result = $this->article->where('cat_id = '.$id)->get();
		foreach($result as $rs)
		{
			$this->article->delete_file($rs['id'],'uploads/article/','image');
			$this->article->delete_file($rs['id'],'uploads/article/thumb/','image');
		}
		$this->article->delete('cat_id',$id);
		$this->category->delete($id);
		set_notify('success', DELETE_DATA_COMPLETE);
		redirect('category/admin/category');
	}
	
	function inc_menu($where = 'parent = 0',$view = 'admin/inc_menu')
	{
		$data['result'] = $this->category->where($where)->get();
		$this->load->view($view,$data);
	}
}
?>