<?php
class categories extends Admin_Controller
{
	function __construct()
	{
		parent::__construct();
		$this->template->set_layout('lightbox');
	}
	
	function index($module = FALSE)
	{
		$data['module'] = $module;
		$categories = new Category();
		$data['categories'] = $categories->sql("SELECT CONCAT(REPEAT( '&#149;&#151; ', (COUNT(parent.name) - 1) ), node.name) AS name
					,node.description,node.slug,node.id 
					FROM categories AS node,
					categories AS parent
					WHERE node.lft BETWEEN parent.lft AND parent.rgt
					AND parent.module = '".$module."'
					AND node.module = '".$module."' 
					AND parent.parents <> 0
					AND node.parents <> 0
					GROUP BY node.name
					ORDER BY node.lft
					")->get_page();
					//die($categories->check_last_query());
		$this->template->build('admin/category_index',$data);
	}
	
	function form($module,$id=FALSE)
	{
			$data['module'] = $module;
			$data['category'] = new Category($id);
			$data[$module] = new $module();
			$this->template->build('admin/category_form',$data);
	}
	
	
	function save($id=FALSE)
	{
		$category = new Category();
		if($id)
		{
			$category->get_by_id($id);
			$module = $category->module;
			unset($_POST['parents']);
			$category->from_array($_POST);
			$category->save();
		}
		else
		{
			$category->get_by_id($_POST['parents']);
			$rgt = $category->rgt;
			$rgt = $rgt - 1;
			$_POST['lft'] = $rgt + 1;
			$_POST['rgt'] = $_POST['lft'] + 1;
			$_POST['module'] = $category->module;
			$module = $category->module;
			$category->clear();
			$category->where(array('rgt >' => $rgt,'module'=>$_POST['module']))->update('rgt','rgt+2',FALSE);
			$category->clear();
			$category->where(array('lft >' => $rgt,'module'=>$_POST['module']))->update('lft','lft+2',FALSE);
			$category->clear();
			$category->from_array($_POST);
			$category->save();
		}
		
		set_notify('success', lang('save_data_complete'));
		redirect('categories/admin/categories/'.$module);
	}
	
	function delete($id)
	{
		$category = new Category();
		$category->select('lft,rgt,module,(rgt-lft+1) width')->get_by_id($id);
		$categories = new Category();
		$content = new $category->module();
		$content->where("category_id in (select id from categories where lft >= ".$category->lft." and rgt <= ".$category->rgt." and module = '".$category->module."')")->get();
   		$content->delete();
		//delete current category

   		$categories->where("lft BETWEEN $category->lft AND $category->rgt AND module='$category->module'")->get();
		$categories->delete();
		$categories->clear();
		//adjust affected parent/child categories
		$categories->where("rgt > $category->rgt AND module='$category->module'")->update('rgt','rgt - '.$category->width,FALSE);
		
		$categories->clear();
		$categories->where("lft > $category->lft AND module='$category->module'")->update('rgt','rgt - '.$category->width,FALSE);
		$categories->clear();
		
		set_notify('success', lang('delete_data_complete'));
		redirect('categories/admin/categories/'.$category->module);
	}
	
	function inc_menu($where = 'parent = 0',$view = 'admin/inc_menu')
	{
		$data['result'] = $this->category->where($where)->get();
		$this->load->view($view,$data);
	}
}
?>