<?php
class Pooll extends Admin_Controller
{
	
	function __construct()
	{
		parent::__construct();
		$this->load->model('pooll_model','pooll');
		$this->load->model('poolldetail_model','detail');
	}
	
	function index()
	{
		$data['result'] = $this->pooll->limit(20)->get();
		$data['pagination'] = $this->pooll->pagination();
		$this->template->build('admin/pooll_index',$data);
	}
	
	function form($id = FALSE)
	{
		//$this->db->debug = TRUE;
		$data['rs'] = $this->pooll->get_row($id);
		if($data['rs'])
		{
			$data['result'] = $this->detail->where('parent = '.$data['rs']['id'])->get();
		}
		$this->template->build('admin/pooll_form',$data);
	}
	
	function save()
	{
		$this->db->debug = TRUE;
		if($_POST)
		{
			$id = $this->pooll->save($_POST);
			
			foreach($_POST['name'] as $key => $item)
			{
				
				if($item)
				{
				$data = (@$_POST['detail_id'][$key])?array('id'=>@$_POST['detail_id'][$key],'name' => $item,'parent'=> $id):array('name' => $item,'parent'=> $id);

				$this->detail->save($data);
				
				}
				
			}
			
			set_notify('success', SAVE_DATA_COMPLETE);
		}
		redirect('pooll/admin/pooll/form/'.$id);
	}
	
	function delete($id)
	{
		if($id)
		{
			$this->pooll->delete($id);
			set_notify('success', DELETE_DATA_COMPLATE);
		} 
		redirect('pooll/admin/pooll');		
	}
	
	function delete_ans($id)
	{
		if($id)
		{
			$parent = $this->detail->get_one('parent',$id);
			$this->detail->delete($id);
			set_notify('success', DELETE_DATA_COMPLETE);
		} 
		redirect('pooll/admin/pooll/form/'.$parent);		
	}
	
	function remove_image($id)
	{
		$this->pooll->delete_file($id,'uploads/pooll/','image');
		$this->pooll->save(array('id' => $id, 'image' => NULL));
		set_notify('success', REMOVE_IMAGE_COMPLATE);
		redirect('pooll/admin/pooll/form/'.$id);	
	}
	
}
?>