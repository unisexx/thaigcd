<?php
class categories extends Admin_Controller
{
	function __construct()
	{
		parent::__construct();
		$this->template->set_layout('lightbox');
	}
	
	function index($module = FALSE)
	{
		$data['module'] = $module;
		$categories = new Category();
		$data['categories'] = $categories->get_page("SELECT CONCAT(REPEAT( '&#149;&#151; ', (COUNT(parent.name) - 1) ), node.name) AS name
					,node.description,node.slug,node.id 
					FROM categories AS node,
					categories AS parent
					WHERE node.lft BETWEEN parent.lft AND parent.rgt
					AND parent.module = '".$module."'
					AND node.module = '".$module."' 
					AND parent.parents <> 0
					AND node.parents <> 0
					GROUP BY node.name
					ORDER BY node.lft
					");
					//die($categories->check_last_query());
		$this->template->build('admin/category_index',$data);
	}
	
	function form($module,$id=FALSE)
	{
			$data['module'] = $module;
			$data['category'] = new Category($id);
			$data[$module] = new $module();
			$this->template->build('admin/category_form',$data);
	}
	
	
	function save($id=FALSE)
	{
		if($id)
		{
			$this->delete($data[$this->primary_key]);
			$rgt = $this->get_one('rgt','id',$data['parent']);
			$rgt = $rgt - 1;
			$this->db->execute("UPDATE $this->table SET rgt=rgt+2 WHERE rgt>$rgt");
			$this->db->execute("UPDATE $this->table SET lft=lft+2 WHERE lft>$rgt");
			$data['lft'] = $rgt + 1;
			$data['rgt'] = $data['lft'] + 1;
			$data['module'] = $this->get_one('module','id',$data['parent']);
			$this->db->AutoExecute($this->table,$data,'INSERT',FALSE);
			return $this->db->insert_id();
		}
		else
		{
			$category = new Category();
			$category = $category->get_by_parents($_POST['parents']);
			$rgt = $category->rgt;
			$rgt = rgt - 1;
			$this->db->query("UPDATE $this->table SET rgt=rgt+2 WHERE rgt>$rgt and module = ".$category->module);
			$this->db->query("UPDATE $this->table SET lft=lft+2 WHERE lft>$rgt and module = ".$category->module);
			$_POST['lft'] = $rgt + 1;
			$_POST['rgt'] = $_POST['lft'] + 1;
			$_POST['module'] = $category->module;
			
			$rgt = $this->get_one('rgt','id',$data['parent']);
			$rgt = $rgt - 1;
			$this->db->execute("UPDATE $this->table SET rgt=rgt+2 WHERE rgt>$rgt");
			$this->db->execute("UPDATE $this->table SET lft=lft+2 WHERE lft>$rgt");
			$data['lft'] = $rgt + 1;
			$data['rgt'] = $data['lft'] + 1;
			$data['module'] = $this->get_one('module','id',$data['parent']);
		}
		$category = new Category($id);
		$category->from_value($_POST);
		$category->save();
		set_notify('success', lang('save_data_complete'));
		redirect('categories/admin/category/'.$module);
	}
	
	function delete($id)
	{
		$result = $this->article->where('cat_id = '.$id)->get();
		foreach($result as $rs)
		{
			$this->article->delete_file($rs['id'],'uploads/article/','image');
			$this->article->delete_file($rs['id'],'uploads/article/thumb/','image');
		}
		$this->article->delete('cat_id',$id);
		$this->category->delete($id);
		set_notify('success', DELETE_DATA_COMPLETE);
		redirect('category/admin/category');
	}
	
	function inc_menu($where = 'parent = 0',$view = 'admin/inc_menu')
	{
		$data['result'] = $this->category->where($where)->get();
		$this->load->view($view,$data);
	}
}
?>